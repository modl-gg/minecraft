package gg.modl.minecraft.core.impl.commands;

import co.aikar.commands.BaseCommand;
import co.aikar.commands.CommandIssuer;
import co.aikar.commands.annotation.*;
import dev.simplix.cirrus.player.CirrusPlayerWrapper;
import gg.modl.minecraft.api.Account;
import gg.modl.minecraft.api.Punishment;
import gg.modl.minecraft.api.http.ModlHttpClient;
import gg.modl.minecraft.api.http.request.AddPunishmentEvidenceRequest;
import gg.modl.minecraft.api.http.response.PunishmentDetailResponse;
import gg.modl.minecraft.core.HttpClientHolder;
import gg.modl.minecraft.core.Platform;
import gg.modl.minecraft.core.impl.cache.Cache;
import gg.modl.minecraft.core.impl.menus.inspect.ModifyPunishmentMenu;
import gg.modl.minecraft.core.impl.menus.util.ChatInputManager;
import gg.modl.minecraft.core.locale.LocaleManager;

import java.util.Map;
import java.util.UUID;

/**
 * Internal command for punishment action buttons (Modify, Link Evidence, Upload Evidence).
 * Not intended to be used directly by players - triggered by clickable chat buttons.
 */
public class PunishmentActionCommand extends BaseCommand {
    private final HttpClientHolder httpClientHolder;
    private final Platform platform;
    private final Cache cache;
    private final LocaleManager localeManager;
    private final String panelUrl;

    public PunishmentActionCommand(HttpClientHolder httpClientHolder, Platform platform, Cache cache,
                                    LocaleManager localeManager, String panelUrl) {
        this.httpClientHolder = httpClientHolder;
        this.platform = platform;
        this.cache = cache;
        this.localeManager = localeManager;
        this.panelUrl = panelUrl;
    }

    private ModlHttpClient getHttpClient() {
        return httpClientHolder.getClient();
    }

    @CommandAlias("modl:punishment-action")
    @Conditions("staff")
    public void punishmentAction(CommandIssuer sender, String action, String punishmentId) {
        if (!sender.isPlayer()) {
            sender.sendMessage(localeManager.getMessage("general.gui_requires_player"));
            return;
        }

        switch (action) {
            case "modify" -> openModifyMenu(sender, punishmentId);
            case "link-evidence" -> promptLinkEvidence(sender, punishmentId);
            case "upload-evidence" -> openUploadPage(sender, punishmentId);
            default -> sender.sendMessage("&cUnknown action: " + action);
        }
    }

    private void openModifyMenu(CommandIssuer sender, String punishmentId) {
        UUID senderUuid = sender.getUniqueId();
        sender.sendMessage(localeManager.getMessage("player_lookup.looking_up", Map.of("player", "#" + punishmentId)));

        getHttpClient().getPunishmentDetail(punishmentId).thenAccept(response -> {
            if (!response.isSuccess() || response.getPunishment() == null) {
                sender.sendMessage(localeManager.getMessage("print.punishment_detail.not_found", Map.of("id", punishmentId)));
                return;
            }

            PunishmentDetailResponse.PunishmentDetail detail = response.getPunishment();
            UUID playerUuid = UUID.fromString(detail.getPlayerUuid());

            // Fetch full player profile for the modify menu
            getHttpClient().getPlayerProfile(playerUuid).thenAccept(profileResponse -> {
                if (profileResponse.getStatus() != 200 || profileResponse.getProfile() == null) {
                    sender.sendMessage(localeManager.getMessage("general.player_not_found"));
                    return;
                }

                Account account = profileResponse.getProfile();
                // Find the matching punishment in the account
                Punishment punishment = null;
                if (account.getPunishments() != null) {
                    for (Punishment p : account.getPunishments()) {
                        if (p.getId().equals(punishmentId)) {
                            punishment = p;
                            break;
                        }
                    }
                }

                if (punishment == null) {
                    sender.sendMessage(localeManager.getMessage("print.punishment_detail.not_found", Map.of("id", punishmentId)));
                    return;
                }

                Punishment finalPunishment = punishment;
                platform.runOnMainThread(() -> {
                    String senderName = "Staff";
                    if (platform.getPlayer(senderUuid) != null) {
                        senderName = platform.getPlayer(senderUuid).username();
                    }

                    ModifyPunishmentMenu menu = new ModifyPunishmentMenu(
                            platform, getHttpClient(), senderUuid, senderName,
                            account, finalPunishment, null, null
                    );

                    CirrusPlayerWrapper player = platform.getPlayerWrapper(senderUuid);
                    menu.display(player);
                });
            }).exceptionally(throwable -> {
                sender.sendMessage(localeManager.getMessage("api_errors.panel_restarting"));
                return null;
            });
        }).exceptionally(throwable -> {
            sender.sendMessage(localeManager.getMessage("api_errors.panel_restarting"));
            return null;
        });
    }

    private void promptLinkEvidence(CommandIssuer sender, String punishmentId) {
        UUID senderUuid = sender.getUniqueId();
        String senderName = "Staff";
        if (platform.getPlayer(senderUuid) != null) {
            senderName = platform.getPlayer(senderUuid).username();
        }

        String finalSenderName = senderName;
        ChatInputManager.requestInput(platform, senderUuid,
                "Enter the evidence URL for punishment #" + punishmentId + ":",
                (url) -> {
                    if (url == null || url.isBlank()) {
                        platform.sendMessage(senderUuid, "&cNo URL provided.");
                        return;
                    }

                    AddPunishmentEvidenceRequest request = new AddPunishmentEvidenceRequest(
                            punishmentId, finalSenderName, url
                    );

                    getHttpClient().addPunishmentEvidence(request).thenAccept(v -> {
                        platform.sendMessage(senderUuid, "&aEvidence linked to punishment #" + punishmentId);
                    }).exceptionally(throwable -> {
                        platform.sendMessage(senderUuid, "&cFailed to link evidence: " + throwable.getMessage());
                        return null;
                    });
                },
                () -> platform.sendMessage(senderUuid, "&7Evidence linking cancelled.")
        );
    }

    private void openUploadPage(CommandIssuer sender, String punishmentId) {
        UUID senderUuid = sender.getUniqueId();
        String senderName = "Staff";
        if (platform.getPlayer(senderUuid) != null) {
            senderName = platform.getPlayer(senderUuid).username();
        }

        sender.sendMessage("&7Generating upload link...");

        getHttpClient().createEvidenceUploadToken(punishmentId, senderName).thenAccept(response -> {
            if (!response.isSuccess() || response.getToken() == null) {
                sender.sendMessage("&cFailed to generate upload link.");
                return;
            }

            String uploadUrl = panelUrl + "/upload-evidence/" + response.getToken();

            // Send clickable open_url message
            String json = String.format(
                "{\"text\":\"\",\"extra\":[" +
                "{\"text\":\"  \"}," +
                "{\"text\":\"Click here to upload evidence\",\"color\":\"green\",\"underlined\":true,\"bold\":true," +
                 "\"clickEvent\":{\"action\":\"open_url\",\"value\":\"%s\"}," +
                 "\"hoverEvent\":{\"action\":\"show_text\",\"value\":\"Opens in your browser\"}}" +
                "]}",
                uploadUrl
            );

            platform.runOnMainThread(() -> {
                platform.sendJsonMessage(senderUuid, json);
            });
        }).exceptionally(throwable -> {
            sender.sendMessage("&cFailed to generate upload link: " + throwable.getMessage());
            return null;
        });
    }
}
